<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Disponibilit√©s - Tiny House</title>

  <!-- ‚úÖ FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet" />

  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
    h1 { text-align:center; margin:10px 0; }
    #back-link { text-align:center; margin-bottom:16px; }
    #back-link a { color:#0071c2; text-decoration:none; font-weight:bold; }
    #legend { text-align:center; margin:10px 0 16px; font-size:14px; color:#333; }
    #legend span { display:inline-block; width:14px; height:14px; border-radius:3px; vertical-align:middle; margin-right:6px; }
    #calendar { max-width: 900px; margin:0 auto; background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    .fc-event { border:none; color:#fff; font-size:.9em; border-radius:8px; padding:2px 4px; }
  </style>
</head>
<body>
  <h1>Disponibilit√©s - Tiny House</h1>
  <div id="back-link"><a href="/index.html">üè† Retour √† l'accueil</a></div>

  <div id="legend">
    <span style="background:#ff5a5f"></span> Airbnb
    &nbsp;&nbsp;&nbsp;
    <span style="background:#0071c2"></span> Booking
    &nbsp;&nbsp;&nbsp;
    <span style="background:#888"></span> Ferm√©
  </div>

  <div id="calendar"></div>

  <!-- ‚úÖ FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/fr.global.min.js"></script>

  <script>
    (async function () {
      const res = await fetch('/api/merged?which=tiny', { cache: 'no-store' });
      const data = await res.json();

      // üìù Traduire les titres si besoin
      const events = data.events.map(ev => {
        let titre = ev.title || 'R√©serv√©';

        // Airbnb ‚Üí "R√©serv√© Airbnb"
        if (ev.source.toLowerCase().includes('airbnb')) {
          titre = 'R√©serv√© Airbnb';
        }
        // Booking ‚Üí "R√©serv√© Booking"
        else if (ev.source.toLowerCase().includes('booking')) {
          titre = 'R√©serv√© Booking';
        }
        // Autres ‚Üí "Ferm√©"
        else if (titre.toLowerCase().includes('closed') || titre.toLowerCase().includes('not available')) {
          titre = 'Ferm√©';
        }

        return { ...ev, title: titre };
      });

      const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        locale: 'fr',
        timeZone: 'local',
        height: 'auto',
        events: events,
        eventDidMount(info) {
          const s = new Date(info.event.start);
          const e = new Date(info.event.end);
          // Tooltip : "R√©serv√© Airbnb\n22/10/2025 ‚Üí 28/10/2025"
          info.el.title = `${info.event.title}\n${s.toLocaleDateString()} ‚Üí ${new Date(e - 1).toLocaleDateString()}`;
        }
      });

      calendar.render();
    })().catch(err => {
      console.error('Erreur:', err);
      document.body.insertAdjacentHTML('beforeend','<p style="color:red;text-align:center">Erreur de chargement.</p>');
    });
  </script>
</body>
</html>

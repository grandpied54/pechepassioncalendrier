<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Disponibilit√©s - Studio Perch√©</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 10px; }
    #back-link { text-align: center; margin-bottom: 20px; }
    #back-link a { text-decoration: none; color: #0071c2; font-weight: bold; }
    #legend { text-align: center; margin-bottom: 20px; }
    #legend span { display: inline-block; width: 15px; height: 15px; border-radius: 3px; margin-right: 5px; vertical-align: middle; }
    #calendar { max-width: 900px; margin: 0 auto; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .fc-event-main { border-radius: 4px; }
    .fc-daygrid-event { margin-right: -6px; min-width: 0 !important; }
    .error-box { max-width: 900px; margin: 1rem auto; color: #b00020; background: #ffecec; padding: .75rem 1rem; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Disponibilit√©s - Studio Perch√©</h1>
  <div id="back-link"><a href="/index.html">üè† Retour √† l'accueil</a></div>

  <div id="legend">
    <span style="background:#ff5a5f;"></span> Airbnb
    <span style="margin-left:20px;background:#0071c2;"></span> Booking
    <span style="margin-left:20px;background:#888;"></span> Ferm√©
  </div>

  <div id="calendar"></div>
  <div id="error" class="error-box" style="display:none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales-all.global.min.js"></script>

  <script>
    const errorBox = document.getElementById('error');

    function showError(msg) {
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
    }

    (async () => {
      try {
        const resp = await fetch('/api/merged?which=studio', { cache: 'no-store' });
        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          console.error('‚ùå API /api/merged non OK', resp.status, text);
          showError(`Erreur API (${resp.status}) ‚Äî D√©tails: ${text || 'aucun'}`);
          return;
        }

        const data = await resp.json();
        if (data.errors && data.errors.length) {
          console.warn('‚ö†Ô∏è Erreurs partielle(s) c√¥t√© API:', data.errors);
        }

        const events = (data.events || []).map(e => ({
          title: e.summary || 'R√©serv√©',
          start: e.start,
          end: e.end,
          color: e.color || '#888',
          extendedProps: { startType: e.startType, endType: e.endType }
        }));

        const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
          initialView: 'dayGridMonth',
          locale: 'fr',
          height: 'auto',
          events,
          eventDidMount(info) {
            const el = info.el;
            el.style.overflow = 'visible';
            el.style.transition = 'none';

            const { startType, endType } = info.event.extendedProps;

            if (startType === 'arrival' || (startType === 'full' && endType === 'full')) {
              el.style.width = 'calc(100% + 6px)';
              el.style.marginRight = '-6px';
              el.style.marginLeft = '0';
            } else if (endType === 'departure') {
              el.style.width = '20%';
              el.style.marginLeft = '0';
              el.style.marginRight = 'auto';
            }

            el.style.position = 'relative';
            el.style.zIndex = '5';
          }
        });

        calendar.render();
        if (!events.length) showError('Aucune r√©servation √† afficher pour le moment.');

      } catch (err) {
        console.error('‚ùå Erreur JS c√¥t√© front:', err);
        showError(`Erreur de chargement du calendrier : ${err?.message || err}`);
      }
    })();
  </script>
</body>
</html>
